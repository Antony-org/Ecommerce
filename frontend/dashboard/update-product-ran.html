<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Product</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/forbiddenAdmin.js"></script>
    <style>
        /* Basic CSS for loader and form layout */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
        }

        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<section class="container">
    <h3>Update Product</h3>
    <form id="updateProductForm" enctype="multipart/form-data">
        <div id="basicFields">
            <div class="form-group">
                <label for="name">Product Name</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="price">Price</label>
                <input type="number" class="form-control" id="price" name="price" required>
            </div>
            <div class="form-group">
                <label for="brand">Brand</label>
                <input type="text" class="form-control" id="brand" name="brand" required>
            </div>
        </div>

        <!-- Dynamic Fields -->
        <div id="dynamicFields"></div>

        <!-- Image Upload Section -->
        <div class="form-group">
            <label for="images">Upload New Images</label>
            <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple>
        </div>

        <button type="button" class="btn btn-primary" id="updateButton">Update Product</button>
    </form>

    <!-- Loader -->
    <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div>
</section>

<script src="../assets/js/updateProduct.js" type="module"></script>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const productId =
        const dynamicFields = document.getElementById("dynamicFields");

        // Show and hide loader functions
        function showLoader() { document.getElementById("loader").style.display = "flex"; }
        function hideLoader() { document.getElementById("loader").style.display = "none"; }

        // Fetch product details including category and specifications
        async function fetchProductDetails() {
            showLoader();
            try {
                const response = await fetch(`http://localhost:9002/api/products/${productId}`);
                const product = await response.json();

                // Populate basic fields
                document.getElementById("name").value = product.name;
                document.getElementById("price").value = product.price;
                document.getElementById("brand").value = product.brand;

                // Fetch and populate dynamic fields based on category
                await fetchSpecifications(product.subCategory.id);
            } catch (error) {
                console.error("Error fetching product details:", error);
            } finally {
                hideLoader();
            }
        }

        // Fetch and display specifications based on subcategory
        async function fetchSpecifications(subCategoryId) {
            try {
                const response = await fetch(`http://localhost:9002/api/subcategories/${subCategoryId}/specifications`);
                const specifications = await response.json();

                dynamicFields.innerHTML = ""; // Clear existing fields
                specifications.subCategorySpecification.specs.forEach(spec => {
                    let field;

                    if (spec.inputType === "dropdown") {
                        field = document.createElement("select");
                        field.classList.add("form-control");
                        field.name = spec.specKey;
                        spec.options.forEach(optionValue => {
                            const option = document.createElement("option");
                            option.value = optionValue;
                            option.textContent = optionValue;
                            field.appendChild(option);
                        });
                    } else {
                        field = document.createElement("input");
                        field.type = spec.inputType || "text";
                        field.classList.add("form-control");
                        field.name = spec.specKey;
                    }

                    // Add field to form
                    const label = document.createElement("label");
                    label.textContent = spec.specKey;
                    dynamicFields.appendChild(label);
                    dynamicFields.appendChild(field);
                });
            } catch (error) {
                console.error("Error fetching specifications:", error);
            }
        }

        // Update product
        document.getElementById("updateButton").addEventListener("click", async (event) => {
            event.preventDefault();

            showLoader();
            const productData = {
                name: document.getElementById("name").value,
                price: parseFloat(document.getElementById("price").value),
                brand: document.getElementById("brand").value,
                specifications: {}
            };

            dynamicFields.querySelectorAll("input, select").forEach(field => {
                productData.specifications[field.name] = field.value;
            });

            const formData = new FormData();
            formData.append("product", JSON.stringify(productData));

            const imageFiles = document.getElementById("images").files;
            Array.from(imageFiles).forEach(file => formData.append("images", file));

            try {
                const response = await fetch(`http://localhost:9002/api/products/${productId}`, {
                    method: "PUT",
                    body: formData
                });

                if (response.ok) {
                    alert("Product updated successfully!");
                } else {
                    console.error("Error updating product");
                }
            } catch (error) {
                console.error("Error updating product:", error);
            } finally {
                hideLoader();
            }
        });

        // Initial call to fetch and display the product details
        fetchProductDetails();
    });

</script>
</body>
</html>
