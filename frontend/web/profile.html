<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="icon" href="../assets/img/electro-logo.png" />
  <meta name="author" content="CodePixar" />
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta charset="UTF-8" />
  <title>Electro</title>
  <script src ="../assets/js/forbidden.js"></script>
  <link rel="stylesheet" href="../assets/css/linearicons.css" />
  <link rel="stylesheet" href="../assets/css/font-awesome.min.css" />
  <link rel="stylesheet" href="../assets/css/themify-icons.css" />
  <link rel="stylesheet" href="../assets/css/bootstrap.css" />
  <link rel="stylesheet" href="../assets/css/owl.carousel.css" />
  <link rel="stylesheet" href="../assets/css/nice-select.css" />
  <link rel="stylesheet" href="../assets/css/nouislider.min.css" />
  <link rel="stylesheet" href="../assets/css/ion.rangeSlider.css" />
  <link rel="stylesheet" href="../assets/css/ion.rangeSlider.skinFlat.css" />
  <link rel="stylesheet" href="../assets/css/magnific-popup.css" />
  <link rel="stylesheet" href="../assets/css/main.css" />
  <link rel="stylesheet" href="../assets/css/style.css" />
  <link rel="stylesheet" href="../assets/css/header.css"/>
  <style>
    .profile-container {
      padding: 50px 0;
      background-color: #f7f7f7;
    }
    .profile-header {
      text-align: center;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .profile-picture {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      margin-bottom: 20px;
    }
    .profile-name {
      font-size: 24px;
      font-weight: bold;
    }
    .edit-profile-btn, .edit-password-btn {
      width: 170px;
      margin-top: 20px;
      padding: 10px 20px;
      border: none;
      background-color: #3C5B6F;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    .profile-form input, .cancel-btn {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    .profile-form label {
      font-weight: bold;
    }
    .save-btn {
      padding: 10px 20px;
      background-color: #067e46;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .cancel-btn {
      padding: 10px 20px;
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .profile-details {
      margin-top: 10px;
    }
  </style>
</head>
<body>
<header class="header_area sticky-header" id="header"></header>
<section class="banner-area organic-breadcrumb">
  <div class="container">
    <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
      <div class="col-first">
        <h1>My Profile</h1>
      </div>
    </div>
  </div>
</section>
<section class="profile-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8">
        <div class="profile-header">
          <h2 class="profile-name" id="profile-name"></h2>
          <button class="edit-profile-btn" onclick="toggleEditForm()">Edit Profile</button>
          <button class="edit-password-btn" onclick="togglePasswordForm()">Change Password</button>
        </div>

        <!-- Profile Edit Form -->
        <form class="profile-form mt-4" id="profileForm" style="display: none" action="/ecommerce/web/profile" method="post">
          <label for="firstName">First Name</label>
          <input type="text" id="firstName" name="firstName" required/>
          <label for="lastName">Last Name</label>
          <input type="text" id="lastName" name="lastName" required/>
          <label for="email">Email</label>
          <input type="email" id="email" name="email" readonly required />
          <div id="emailError" class="text-danger"></div>

          <!-- Address fields -->
          <label for="addressOne">Address Line 1</label>
          <input type="text" id="addressOne" name="addressOne"  />
          <label for="city">City</label>
          <input type="text" id="city" name="city"  />
          <label for="country">Country</label>
          <input type="text" id="country" name="country"  />
          <label for="zipCode">Zip Code</label>
          <input type="text" id="zipCode" name="zipCode"  />

          <label for="phone">Phone</label>
          <input type="tel" id="phone" pattern="[0-9]{11}" name="phone" />
          <label for="date">Date Of Birth</label>
          <input type="date" id="date" name="date" max="2013-01-01" min="1900-01-01"  />
          <input type="submit" class="save-btn" value="Save Changes" />
          <button type="button" class="cancel-btn" onclick="toggleEditForm()">Cancel</button>
        </form>


        <!-- Password Change Form -->
        <form class="profile-form mt-4" id="passwordForm" style="display: none" action="/ecommerce/web/update-password" method="post">
          <label for="password">New Password</label>
          <input type="password" id="password" placeholder="Enter new password" pattern="(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z]).{8,30}" name="password" required />

          <label for="confirmPassword">Confirm Password</label>
          <input type="password" id="confirmPassword" placeholder="Enter password confirmation" required />
          <div id="confirmPasswordError" class="text-danger"></div>

          <input type="submit" class="save-btn" value="Change Password" />
          <button type="button" class="cancel-btn" onclick="togglePasswordForm()">Cancel</button>
        </form>

        <!-- Profile Details Section -->
        <div id="profileDetails" class="profile-details">
          <h4>About</h4>
          <p><strong id="customer-firstname">First Name:</strong> <span id="customer-firstname-value"></span></p>
          <p><strong id="customer-lastname">Last Name:</strong> <span id="customer-lastname-value"></span></p>
          <p><strong id="customer-email">Email:</strong> <span id="customer-email-value"></span></p>
          <p><strong id="customer-address-one">Address Line 1:</strong> <span id="customer-address-one-value"></span></p>
          <p><strong id="customer-city">City:</strong> <span id="customer-city-value"></span></p>
          <p><strong id="customer-country">Country:</strong> <span id="customer-country-value"></span></p>
          <p><strong id="customer-zip">Zip Code:</strong> <span id="customer-zip-value"></span></p>
          <p><strong id="customer-phone">Phone:</strong> <span id="customer-phone-value"></span></p>
          <p><strong id="customer-date">Date Of Birth:</strong> <span id="customer-date-value"></span></p>
        </div>
      </div>
    </div>
  </div>
</section>

<footer class="footer-area section_gap" id="footer"></footer>
<script src="../assets/js/vendor/jquery-2.2.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="../assets/js/vendor/bootstrap.min.js"></script>
<script src="../assets/js/jquery.ajaxchimp.min.js"></script>
<script src="../assets/js/jquery.nice-select.min.js"></script>
<script src="../assets/js/jquery.sticky.js"></script>
<script src="../assets/js/nouislider.min.js"></script>
<script src="../assets/js/jquery.magnific-popup.min.js"></script>
<script src="../assets/js/owl.carousel.min.js"></script>
<script src="../assets/js/gmaps.min.js"></script>
<script src="../assets/js/main.js"></script>
<script>
  $(document).ready(function(){
    const token = localStorage.getItem('token');
    if (token) {
      $.ajax({
        url: "http://localhost:8080/customers/profile",
        type: "GET",
        headers: {
          "Authorization": "Bearer " + token
        },
        success: function(data) {
          console.log(data);

          // Access the customer and address from the data
          const customer = data.data[0]; // Get the customer object
          const address = data.data[1]; // Get the address object
        console.log(address);

          $('#profile-name').text(customer.firstName + " " + customer.lastName);
          $('#customer-firstname-value').text(customer.firstName);
          $('#firstName').val(customer.firstName);
          $('#customer-lastname-value').text(customer.lastName);
          $('#lastName').val(customer.lastName);
          $('#customer-email-value').text(customer.email);
          $('#email').val(customer.email);
          console.log(data);

          // Check if address exists and has the necessary fields
          if (address) {
            console.log(data);
            $('#customer-address-value').text(
                    (address.AddressOne || '') + ", " +
                    (address.City || '') + ", " +
                    (address.Country || '') + ", " +
                    (address.ZipCode || '')
            );
            $('#addressOne').val(address.AddressOne || '');
            $('#city').val(address.City || '');
            $('#country').val(address.Country || '');
            $('#zipCode').val(address.ZipCode || '');

            $('#customer-address-one-value').text(address.AddressOne || '');
            $('#customer-city-value').text(address.City || '');
            $('#customer-country-value').text(address.Country || '');
            $('#customer-zip-value').text(address.ZipCode || '');
          } else {
            // Clear or hide address fields if address data is missing
            $('#customer-address-value').text("No address provided");
            $('#addressOne').val('');
            $('#city').val('');
            $('#country').val('');
            $('#zipCode').val('');
          }

          $('#customer-phone-value').text(customer.phone);
          $('#phone').val(customer.phone);
          $('#customer-date-value').text(customer.dateOfBirth);

          let date = new Date(customer.dateOfBirth);
          date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
          let formattedDate = date.toISOString().split('T')[0];
          $('#date').val(formattedDate);
        },
        error: function(xhr) {
          if (xhr.status === 401) {
            alert("Your session has expired. Please log in again.");
            window.location.href = '/web/auth/login.html';
          }
          console.error("Failed to fetch profile data", xhr);
        }
      });
    } else {
      alert("No token found. Please log in.");
      window.location.href = '/web/auth/login.html';
    }
  });

  function toggleEditForm() {
    const profileForm = document.getElementById("profileForm");
    const passwordForm = document.getElementById("passwordForm");
    const details = document.getElementById("profileDetails");

    profileForm.style.display = profileForm.style.display === "none" ? "block" : "none";
    passwordForm.style.display = "none";
    details.style.display = details.style.display === "none" ? "block" : "none";
  }

  function togglePasswordForm() {
    const profileForm = document.getElementById("profileForm");
    const passwordForm = document.getElementById("passwordForm");
    const details = document.getElementById("profileDetails");

    passwordForm.style.display = passwordForm.style.display === "none" ? "block" : "none";
    profileForm.style.display = "none";
    details.style.display = "none";
  }

  var mailIsAvailable = true;
  function checkValidEmail() {
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var responseText = this.responseText;
        if(responseText == "true"){
          mailIsAvailable = true;
          document.getElementById("emailError").innerText = "";
        } else {
          mailIsAvailable = false;
          document.getElementById("emailError").innerText = "This email is not available";
        }
      }
    };
    xhttp.open("GET", "check-email?email=" + document.getElementById("email").value, true);
    xhttp.send();
  }

  $(document).ready(function () {
    $('#confirmPassword, #password').on('input', function () {
      checkPasswords();
    });

    $('#profileForm').on('submit', function (e) {
      if (!mailIsAvailable) {
        e.preventDefault();
        alert('This email is not available.');
      }
    });

    $('#passwordForm').on('submit', function (e) {
      if (!checkPasswords()) {
        e.preventDefault();
        alert('Passwords do not match. Please correct it before submitting.');
      }
    });

    function checkPasswords() {
      var password = $('#password').val();
      var confirmPassword = $('#confirmPassword').val();

      if (password !== confirmPassword) {
        $('#confirmPasswordError').text('Passwords do not match');
        $('#confirmPassword').addClass('is-invalid');
        return false;
      } else {
        $('#confirmPasswordError').text('');
        $('#confirmPassword').removeClass('is-invalid');
        return true;
      }
    }
  });

  $('#profileForm').on('submit', function (e) {
    e.preventDefault(); // Prevent default form submission

    // Gather form data, including address fields as a nested object
    const data = {
      firstName: $('#firstName').val(),
      lastName: $('#lastName').val(),
      address: {
        addressOne: $('#addressOne').val(),
        city: $('#city').val(),
        country: $('#country').val(),
        zipCode: $('#zipCode').val()
      },
      phone: $('#phone').val(),
      dateOfBirth: $('#date').val()
    };

    const token = localStorage.getItem('token');
    if (token) {
      $.ajax({
        url: "http://localhost:8080/customers/profile",
        type: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        data: JSON.stringify(data),
        success: function(response) {
          alert("Profile updated successfully");
          toggleEditForm();
          // Optionally, refresh profile data on success
        },
        error: function(xhr) {
          alert("Failed to update profile. Please try again.");
          console.error("Error:", xhr);
        }
      });
    } else {
      alert("No token found. Please log in.");
      window.location.href = '/web/auth/login.html';
    }
  });

  $('#passwordForm').on('submit', function (e) {
    e.preventDefault(); // Prevent default form submission

    const newPassword = $('#password').val();

    $.ajax({
      url: "http://localhost:8080/customers/update-password",
      type: "PUT",
      contentType: "application/json",
      headers: {
        "Authorization": "Bearer " + localStorage.getItem('token')
      },
      data: JSON.stringify({ newPassword: newPassword }),
      success: function (response) {
        alert(response);
      },
      error: function (xhr) {
        console.error("Error updating password", xhr);
        alert(xhr.responseJSON.message || "Failed to update password");
      }
    });
  });
</script>

<script src="../assets/js/loadHeader.js"></script>
</body>
</html>